name: Release All Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        default: '0.1.0'

env:
  APP_NAME: Hawkeye

jobs:
  # ============================================
  # Desktop Builds (Mac/Windows/Linux)
  # ============================================
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: darwin
            arch: arm64
            artifact_name: hawkeye-desktop-mac-arm64
          - os: macos-13
            platform: darwin
            arch: x64
            artifact_name: hawkeye-desktop-mac-x64
          - os: windows-latest
            platform: win32
            arch: x64
            artifact_name: hawkeye-desktop-win-x64
          - os: ubuntu-latest
            platform: linux
            arch: x64
            artifact_name: hawkeye-desktop-linux-x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        if: matrix.platform != 'win32'

      - name: Setup Rust (Windows)
        uses: dtolnay/rust-action@stable
        if: matrix.platform == 'win32'
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install Linux Dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libssl-dev

      - name: Install Dependencies
        run: pnpm install
        working-directory: packages/desktop

      - name: Build Desktop App
        run: pnpm build
        working-directory: packages/desktop
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      - name: Sign macOS App
        if: matrix.platform == 'darwin'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: echo "Signing macOS app..."

      - name: Upload macOS DMG
        if: matrix.platform == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: packages/desktop/src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: warn

      - name: Upload Windows Installer
        if: matrix.platform == 'win32'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: packages/desktop/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: warn

      - name: Upload Linux AppImage
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: packages/desktop/src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: warn

  # ============================================
  # Chrome Extension Build
  # ============================================
  build-chrome-extension:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install
        working-directory: packages/chrome-extension

      - name: Build Chrome Extension
        run: pnpm build
        working-directory: packages/chrome-extension

      - name: Create Extension ZIP
        run: |
          cd packages/chrome-extension/dist
          zip -r ../hawkeye-chrome-extension.zip .

      - name: Upload Chrome Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hawkeye-chrome-extension
          path: packages/chrome-extension/hawkeye-chrome-extension.zip

      - name: Upload to Chrome Web Store
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: packages/chrome-extension/hawkeye-chrome-extension.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
        continue-on-error: true

  # ============================================
  # Firefox Extension Build (Optional)
  # ============================================
  build-firefox-extension:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install
        working-directory: packages/chrome-extension

      - name: Build Firefox Extension
        run: pnpm build:firefox
        working-directory: packages/chrome-extension
        continue-on-error: true

      - name: Create Firefox XPI
        run: |
          if [ -d "packages/chrome-extension/dist-firefox" ]; then
            cd packages/chrome-extension/dist-firefox
            zip -r ../hawkeye-firefox-extension.xpi .
          fi
        continue-on-error: true

      - name: Upload Firefox Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hawkeye-firefox-extension
          path: packages/chrome-extension/hawkeye-firefox-extension.xpi
          if-no-files-found: ignore

  # ============================================
  # VS Code Extension Build
  # ============================================
  build-vscode-extension:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install
        working-directory: packages/vscode-extension

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Build VS Code Extension
        run: pnpm build
        working-directory: packages/vscode-extension

      - name: Package VSIX
        run: vsce package -o hawkeye-vscode-extension.vsix
        working-directory: packages/vscode-extension

      - name: Upload VS Code Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hawkeye-vscode-extension
          path: packages/vscode-extension/hawkeye-vscode-extension.vsix

      - name: Publish to VS Code Marketplace
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: vsce publish -p ${{ secrets.VSCE_PAT }}
        working-directory: packages/vscode-extension
        continue-on-error: true

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    needs: [build-desktop, build-chrome-extension, build-firefox-extension, build-vscode-extension]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display Artifacts
        run: ls -R artifacts

      - name: Get Version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Hawkeye ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            artifacts/hawkeye-desktop-mac-arm64/*.dmg
            artifacts/hawkeye-desktop-mac-x64/*.dmg
            artifacts/hawkeye-desktop-win-x64/*.exe
            artifacts/hawkeye-desktop-linux-x64/*.AppImage
            artifacts/hawkeye-chrome-extension/*.zip
            artifacts/hawkeye-firefox-extension/*.xpi
            artifacts/hawkeye-vscode-extension/*.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Latest Release Tag
        run: |
          git tag -f latest
          git push -f origin latest
        continue-on-error: true
